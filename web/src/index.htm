<!DOCTYPE html>
<html>
  <head>
    <title>STORINATOR Switch</title>
    <!-- TODO icon -->
    <link rel="icon" type="image/png" href="power.png" />
    <link rel="stylesheet" href="style.css" />
  </head>
  <body>
    <h2>STORINATOR</h2>

    <div class="statusContainer">
      <div class="led-box">
        <div id="powerLed" class="led-off"></div>
        <p>Power</p>
      </div>
    </div>

    <div class="operationContainer">
      <button type="button" class="powerOnButton" onclick="sendCommand(CMD_POWER_ON)">
        ON
      </button>
      <button type="button" class="standbyButton" onclick="sendCommand(CMD_STAND_BY)">
        STANDBY
      </button>
      <button type="button" class="resetButton" onclick="sendCommand(CMD_RESET)">
        RESET
      </button>
      <button type="button" class="killButton" onclick="sendCommand(CMD_KILL)">
        KILL
      </button>
    </div>

    <script>
      var state = false
      const CMD_POWER_ON = "powerOn", CMD_STAND_BY = "standBy", CMD_RESET = "reset", CMD_KILL = "kill"
      const REQ_POWER_STATUS = "powerStatus"

      setInterval(() =>  {
        requestStatus(REQ_POWER_STATUS)
      }, 3000)

      function togglePowerLed(state) {
        const powerLed = document.getElementById('powerLed')
        if (state) {
          powerLed.classList.remove('led-off')
          powerLed.classList.add('led-green')
        } else {
          powerLed.classList.remove('led-green')
          powerLed.classList.add('led-off')
        }
      }

      function sendCommand(request) {
        if (!confirm(request.toUpperCase())) return

        var xhttp = new XMLHttpRequest()
        xhttp.onreadystatechange = function () {
          if (this.readyState == 4 && this.status == 200) {
            console.debug(`sendCommand:${request}:${this.responseText}`)
            alert('Action confirmed.')
          }
        }
        xhttp.open('GET', request, true)
        xhttp.send()
      }

      function requestStatus(request) {
        var xhttp = new XMLHttpRequest()
        xhttp.onreadystatechange = function () {
          if (this.readyState == 4 && this.status == 200) {
            console.debug(`requestStatus:${request}:${this.responseText}`)
            if(request == REQ_POWER_STATUS && typeof this.response === "string") {
              if(this.response.toString().includes(REQ_POWER_STATUS+":on"))
                togglePowerLed(true)
              else
                togglePowerLed(false)
            }
          }
        }
        xhttp.open('GET', request, true)
        xhttp.send()
      }
    </script>
  </body>
</html>
