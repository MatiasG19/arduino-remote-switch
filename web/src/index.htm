<!DOCTYPE html>
<html>
  <head>
    <title>STORINATOR Switch</title>
    <!-- TODO icon -->
    <link rel="icon" type="image/png" href="power.png" />
    <link rel="stylesheet" href="style.css" />
  </head>
  <body>
    <div class="heading">STORINATOR</div>

    <button
    id="powerLed"
    type="button"
    class="button"
    disabled>
    POWER LED
    </button>
    <button
      id="powerBtn"
      type="button"
      class="activeButton"
      onclick="sendCommand(CMD_POWER_ON)">
      POWER ON
    </button>
    <button
      id="standByBtn"
      type="button"
      class="activeButton"
      onclick="sendCommand(CMD_STAND_BY)">
      STANDBY
    </button>
    <button
      id="resetBtn"
      type="button"
      class="activeButton"
      onclick="sendCommand(CMD_RESET)">
      RESET
    </button>
    <button
      id="killBtn"
      type="button"
      class="activeButton"
      onclick="sendCommand(CMD_KILL)">
      KILL
  </button>

  <a href="https://github.com/MatiasG19/arduino-remote-switch">Arduino Remote Switch on GitHub</a>

    <script>
      const CMD_POWER_ON = "powerOn", CMD_STAND_BY = "standBy", CMD_RESET = "reset", CMD_KILL = "kill"
      const REQ_POWER_STATUS = "powerStatus"

      setInterval(() =>  {
        togglePowerLedColor(true)
        requestStatus(REQ_POWER_STATUS)
      }, 3000)

      function togglePowerLedColor(state) {
        const powerLed = document.getElementById('powerLed')
        if (state) {
          powerLed.style.color = "#27e670"
        } else {
          powerLed.style.color = "#eb1e8f"
        }
      }

      function sendCommand(type) {
        if (!confirm(type.toUpperCase())) return

        var xhttp = new XMLHttpRequest()
        xhttp.onreadystatechange = function () {
          if (this.readyState == 4 && this.status == 200) {
            console.debug(`sendCommand:${request}:${this.responseText}`)
            alert('Action confirmed.')
          }
        }
        xhttp.open('GET', request, true)
        xhttp.send()
      }

      function requestStatus(request) {
        var xhttp = new XMLHttpRequest()
        xhttp.onreadystatechange = function () {
          if (this.readyState == 4 && this.status == 200) {
            console.debug(`requestStatus:${request}:${this.responseText}`)
            if(request == REQ_POWER_STATUS && typeof this.response === "string") {
              if(this.response.toString().includes(REQ_POWER_STATUS+":on"))
                togglePowerLedColor(true)
              else
                togglePowerLedColor(false)
            }
          }
        }
        xhttp.open('GET', request, true)
        xhttp.send()
      }
    </script>
  </body>
</html>
